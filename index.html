<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ®ºæ³•å®˜åŠ©æ‰‹ v5.7</title>
    <style>
        /* è¦–è¦ºé¢¨æ ¼ä¿æŒ v4.1 é«˜é£½å’Œåº¦ï¼Œåº•éƒ¨æœ‰ iPhone é˜²æ“‹ç·©è¡å€ */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a1a1a; color: #ddd; padding: 10px; padding-bottom: 150px; max-width: 700px; margin: 0 auto; }
        h2 { text-align: center; color: #e74c3c; margin: 5px 0; letter-spacing: 2px; font-size: 1.4em; }
        
        /* å‹åˆ©æ¨¡å¼é–‹é—œæ¨£å¼ */
        .mode-switch { text-align: center; margin: 10px 0; background: #333; padding: 8px; border-radius: 8px; font-size: 1em; border: 1px solid #555; }
        .radio-label { margin: 0 10px; cursor: pointer; font-weight: bold; color: #ecf0f1; }
        input[type="radio"] { transform: scale(1.2); margin-right: 5px; }

        .dashboard { display: flex; justify-content: space-between; background: #2c3e50; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .count-box { text-align: center; width: 30%; }
        .count-number { font-size: 1.4em; font-weight: bold; } 
        .c-wolf { color: #e74c3c; } 
        .c-god { color: #f1c40f; }  
        .c-villager { color: #2ecc71; } 
        
        .win-banner { display: none; background: #c0392b; color: white; text-align: center; padding: 10px; font-size: 1.5em; font-weight: bold; border-radius: 8px; margin-bottom: 10px; animation: pop 0.5s; border: 2px solid #e74c3c; }

        .section { background: #34495e; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #7f8c8d; }
        .sec-wolf { border-left-color: #c0392b; }
        .sec-day { border-left-color: #e67e22; }
        .section-header { font-weight: bold; margin-bottom: 5px; color: #ecf0f1; display: flex; justify-content: space-between; font-size: 0.95em; }

        select, input { padding: 6px; margin: 3px 0; background: #2c3e50; color: white; border: 1px solid #7f8c8d; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { border: none; padding: 10px; border-radius: 4px; cursor: pointer; color: white; width: 100%; margin-top: 5px; font-size: 14px; font-weight: bold; }
        .btn-add { background: #2980b9; width: auto; padding: 6px 12px; }
        .btn-calc { background: #c0392b; font-size: 1.1em; }
        .btn-day { background: #d35400; }
        
        .role-item { display: flex; align-items: center; justify-content: space-between; padding: 6px; background: #2c3e50; margin-bottom: 4px; border-radius: 3px; border-left: 4px solid #555; }
        .type-wolf { border-left-color: #e74c3c; }
        .type-god { border-left-color: #f1c40f; }
        .type-villager { border-left-color: #2ecc71; }
        .dead { opacity: 0.5; text-decoration: line-through; background: #222; }
        .role-num { width: 50px; text-align: center; background: #ecf0f1; color: #2c3e50; font-weight: bold; margin: 0 5px; font-size: 1.1em; padding: 4px; border:none; }
        
        .badge { font-size: 0.7em; padding: 1px 3px; border-radius: 3px; margin-left: 3px; }
        .b-ghoul { background: #8e44ad; }
        .b-beauty { background: #fd79a8; color: #2d3436; }
        .b-bear { background: #d35400; }
        .b-idiot { background: #95a5a6; color: #2c3e50; }

        .night-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .night-group label { font-size: 0.85em; color: #bdc3c7; }

        #log-area { background: #000; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; border: 1px solid #444; line-height: 1.6; white-space: pre-wrap; font-size: 13px; color: #eee; }
        
        .log-header { color: #3498db; font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #333; padding-bottom:3px; display:block; }
        .log-action { color: #bdc3c7; } 
        .log-kill { color: #e74c3c; font-weight: bold; } 
        .log-poison { color: #9b59b6; font-weight: bold; } 
        .log-save { color: #2ecc71; } 
        .log-guard { color: #f1c40f; } 
        .log-info { color: #3498db; }
        .log-idiot { color: #f1c40f; font-weight: bold; border: 1px solid #f1c40f; padding: 2px 5px; border-radius: 3px; }
        .log-bear-yes { color: #e74c3c; font-weight: bold; background: #2c3e50; padding: 3px 6px; border-radius: 4px; border: 1px solid #c0392b; display: inline-block; margin-top: 5px;}
        .log-bear-no { color: #2ecc71; font-weight: bold; background: #2c3e50; padding: 3px 6px; border-radius: 4px; border: 1px solid #27ae60; display: inline-block; margin-top: 5px;}
        .log-hunter-yes { color: #2ecc71; font-weight: bold; background: #2c3e50; padding: 2px 5px; border-radius: 3px;}
        .log-hunter-no { color: #e74c3c; font-weight: bold; background: #2c3e50; padding: 2px 5px; border-radius: 3px; text-decoration: line-through;}
        .log-immune { color: #55efc4; font-weight: bold; }
        .log-win { color: #f1c40f; font-weight: bold; font-size: 1.1em; border: 2px solid #f1c40f; padding: 5px; text-align: center; margin-top: 5px; }
        .log-tie { color: #ecf0f1; font-style: italic; background: #7f8c8d; padding: 2px 5px; border-radius: 3px; }

        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®ºæ³•å®˜ v5.7</h2>

    <div id="win-banner" class="win-banner"></div>

    <div class="dashboard">
        <div class="count-box"><div class="c-wolf">ç‹¼äºº</div><div id="cnt-wolf" class="count-number">0</div></div>
        <div class="count-box"><div class="c-god">ç¥è·</div><div id="cnt-god" class="count-number">0</div></div>
        <div class="count-box"><div class="c-villager">å¹³æ°‘</div><div id="cnt-villager" class="count-number">0</div></div>
    </div>

    <div class="section">
        <div class="section-header">1. è§’è‰²é…ç½® (è‡ªå‹•æ’åº)</div>
        <div style="display: flex; gap: 5px;">
            <select id="roleSelect">
                <optgroup label="ğŸº ç‹¼äººé™£ç‡Ÿ">
                    <option value="ç‹¼äºº|wolf">ç‹¼äºº</option>
                    <option value="ç‹¼ç‹|wolf">ç‹¼ç‹</option>
                    <option value="ç™½ç‹¼ç‹|wolf">ç™½ç‹¼ç‹</option>
                    <option value="æƒ¡éˆé¨å£«|wolf">æƒ¡éˆé¨å£«</option>
                    <option value="éš±ç‹¼|wolf">éš±ç‹¼</option>
                    <option value="ç‹¼ç¾äºº|wolf">ç‹¼ç¾äºº</option>
                </optgroup>
                <optgroup label="ğŸ”® ç¥è·é™£ç‡Ÿ">
                    <option value="é è¨€å®¶|god">é è¨€å®¶</option>
                    <option value="å¥³å·«|god">å¥³å·«</option>
                    <option value="çµäºº|god">çµäºº</option>
                    <option value="å®ˆè¡›|god">å®ˆè¡›</option>
                    <option value="é¨å£«|god">é¨å£«</option>
                    <option value="é¦´ç†Šå¸«|god">é¦´ç†Šå¸«</option>
                    <option value="ç™½ç™¡|god">ç™½ç™¡</option>
                </optgroup>
                <optgroup label="ğŸ‘± å¹³æ°‘é™£ç‡Ÿ">
                    <option value="å¹³æ°‘|villager">å¹³æ°‘</option>
                    <option value="è€æµæ°“|villager">è€æµæ°“</option>
                </optgroup>
            </select>
            <button class="btn-add" onclick="addRole()">æ–°å¢</button>
        </div>
        <div id="role-list" style="margin-top: 5px;"></div>
    </div>

    <div class="mode-switch">
        <span style="color: #aaa; margin-right: 5px;">å‹åˆ©æ¢ä»¶:</span>
        <label class="radio-label"><input type="radio" name="winMode" value="side" checked onchange="checkWin()">å± é‚Š</label>
        <label class="radio-label"><input type="radio" name="winMode" value="city" onchange="checkWin()">å± åŸ</label>
    </div>

    <div class="section sec-wolf">
        <div class="section-header">ğŸŒ™ å¤œæ™šè¡Œå‹• (æŒ‰é †åºçµç®—)</div>
        <div class="night-grid">
            <div class="night-group">
                <label>ğŸº ç‹¼åˆ€:</label>
                <input type="number" id="n-wolf" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ”® é é©—:</label>
                <input type="number" id="n-seer" placeholder="#">
            </div>
            <div class="night-group">
                <label>â˜ ï¸ æ¯’:</label>
                <input type="number" id="n-poison" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ’Š æ•‘:</label>
                <input type="number" id="n-save" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ›¡ï¸ å®ˆ:</label>
                <input type="number" id="n-guard" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ’‹ é€£:</label>
                <input type="number" id="n-beauty" placeholder="#">
            </div>
        </div>
        <button class="btn-calc" onclick="resolveNight()">ğŸŒ• å¤©äº®çµç®—</button>
    </div>

    <div class="section sec-day">
        <div class="section-header">â˜€ï¸ ç™½å¤©æ“ä½œ (æ”¾é€å¡«0ç‚ºå¹³ç¥¨)</div>
        <div style="display: flex; gap: 5px;">
            <select id="day-action" style="flex: 1;">
                <option value="æ”¾é€">ğŸ—³ï¸ æ”¾é€</option>
                <option value="çµäººå¤œæ§">ğŸ”« çµäººé–‹æ§ (å¤œäº¡å¸¶äºº)</option>
                <option value="çµäººæ—¥æ§">ğŸ”« çµäººé–‹æ§ (æ—¥äº¡/è¢«æŠ•)</option>
                <option value="ç‹¼ç‹é–‹æ§">ğŸº ç‹¼ç‹é–‹æ§</option>
                <option value="æ±ºé¬¥">âš”ï¸ é¨å£«æ±ºé¬¥</option>
                <option value="ç‹¼äººè‡ªçˆ†">ğŸ’¥ ç‹¼äººè‡ªçˆ†</option>
                </select>
            <input type="number" id="day-target" placeholder="#" style="width: 50px;">
            <button class="btn-day" style="width: auto;" onclick="dayAction()">åŸ·è¡Œ</button>
        </div>
    </div>

    <div id="log-area"><span style="color:#7f8c8d;">ç­‰å¾…éŠæˆ²é–‹å§‹...</span></div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="resetKeepConfig()" style="background: #2980b9; flex: 2;">ä¿ç•™é…ç½®é‡æ–°éŠæˆ²</button>
        <button onclick="if(confirm('ç¢ºå®šè¦å®Œå…¨æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')) location.reload();" style="background: #555; flex: 1;">å®Œå…¨é‡ç½®</button>
    </div>

    <script>
        let roles = [];
        let beautyLink = null;
        let nightCount = 1;
        let pendingNightGun = false; // å¤œæ§æ¨™è¨˜
        let pendingDayGun = false;   // æ—¥æ§æ¨™è¨˜ (v5.7 æ–°å¢)

        function addRole() {
            const val = document.getElementById("roleSelect").value.split('|');
            const name = val[0];
            const type = val[1];
            roles.push({
                name: name, type: type, number: '', alive: true,
                isGhoul: name === 'æƒ¡éˆé¨å£«', reboundUsed: false,
                isHidden: name === 'éš±ç‹¼', isRogue: name === 'è€æµæ°“',
                isBeauty: name === 'ç‹¼ç¾äºº', isHunter: (name === 'çµäºº' || name === 'ç‹¼ç‹'),
                isBear: name === 'é¦´ç†Šå¸«', isIdiot: name === 'ç™½ç™¡', isWWK: name === 'ç™½ç‹¼ç‹'
            });
            sortRoles(); render(); updateStats();
        }

        function sortRoles() {
            const order = { 'wolf': 1, 'god': 2, 'villager': 3 };
            roles.sort((a, b) => order[a.type] - order[b.type]);
        }

        function render() {
            const list = document.getElementById("role-list");
            list.innerHTML = "";
            let hasAliveWWK = false;

            roles.forEach((r, idx) => {
                const div = document.createElement("div");
                div.className = `role-item type-${r.type} ${r.alive ? '' : 'dead'}`;
                let tags = "";
                if (r.isGhoul) tags += `<span class="badge b-ghoul">æƒ¡éˆ</span>`;
                if (r.isBeauty) tags += `<span class="badge b-beauty">ç‹¼ç¾</span>`;
                if (r.isBear) tags += `<span class="badge b-bear">ç†Š</span>`;
                if (r.isIdiot) tags += `<span class="badge b-idiot">ç™½ç™¡</span>`;

                if (r.isWWK && r.alive) hasAliveWWK = true;

                div.innerHTML = `
                    <div style="flex:1">
                        <span style="font-weight:bold">${r.name}</span>
                        ${tags}
                    </div>
                    <input type="number" class="role-num" placeholder="#" value="${r.number}" 
                        onchange="roles[${idx}].number=this.value" ${!r.alive?'disabled':''}>
                    <button style="width:auto; padding:5px 10px; background:${r.alive?'#2ecc71':'#e74c3c'}" 
                        onclick="toggleLife(${idx})">${r.alive?'å­˜':'äº¡'}</button>
                    <button style="width:auto; background:none; padding:0 5px;" onclick="delRole(${idx})">âœ•</button>
                `;
                list.appendChild(div);
            });
            updateDayOptions(hasAliveWWK);
        }

        function updateDayOptions(hasAliveWWK) {
            const select = document.getElementById("day-action");
            const wwkOptionValue = "ç™½ç‹¼ç‹è‡ªçˆ†";
            let exists = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === wwkOptionValue) exists = true;
            }
            if (hasAliveWWK && !exists) {
                const opt = document.createElement("option");
                opt.value = wwkOptionValue;
                opt.text = "ğŸ’¥ ç™½ç‹¼ç‹è‡ªçˆ†å¸¶äºº";
                opt.style.color = "#e74c3c";
                opt.style.fontWeight = "bold";
                select.add(opt);
            } else if (!hasAliveWWK && exists) {
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === wwkOptionValue) select.remove(i);
                }
            }
        }

        function toggleLife(idx) {
            roles[idx].alive = !roles[idx].alive;
            render(); updateStats(); checkWin();
        }
        function delRole(idx) { roles.splice(idx, 1); render(); updateStats(); }

        function updateStats() {
            let w=0, g=0, v=0;
            roles.forEach(r => {
                if (r.alive) {
                    if (r.type === 'wolf') w++;
                    if (r.type === 'god') g++;
                    if (r.type === 'villager') v++;
                }
            });
            document.getElementById("cnt-wolf").innerText = w;
            document.getElementById("cnt-god").innerText = g;
            document.getElementById("cnt-villager").innerText = v;
            return { w, g, v };
        }

        function checkWin() {
            const counts = updateStats();
            const mode = document.querySelector('input[name="winMode"]:checked').value;
            const banner = document.getElementById("win-banner");
            
            // 1. å¥½äººå‹åˆ© (ç‹¼äººå…¨æ»…)
            if (counts.w === 0 && roles.length > 0) {
                banner.innerText = "ğŸ† å¥½äººé™£ç‡Ÿ ç²å‹ï¼";
                banner.style.display = "block";
                log("ğŸ† éŠæˆ²çµæŸï¼šå¥½äººé™£ç‡Ÿç²å‹", 'log-win');
                return;
            }

            let wolfWin = false;
            let winReason = "";

            const goodCount = counts.g + counts.v;
            // 2. ç‹¼äººç¶ç¥¨è¦å‰‡ (ç‹¼ >= å¥½äºº)
            if (counts.w >= goodCount && goodCount > 0) {
                // --- v5.7 ä¿®æ­£ï¼šæ—¥æ§æˆ–å¤œæ§æœªç™¼å‹•ï¼Œæš«åœå®£åˆ¤ ---
                if (pendingNightGun || pendingDayGun) {
                    log("âš ï¸ ç‹¼äººæ•¸é‡å·²é”æ¨™ï¼Œä½†éœ€ç­‰å¾…çµäºº/ç‹¼ç‹é–‹æ§...", 'log-info');
                    banner.style.display = "none";
                    return; 
                }
                wolfWin = true;
                winReason = "ç‹¼äººç¶ç¥¨ (ç‹¼ >= å¥½äºº)";
            }
            // 3. å± é‚Š
            else if (mode === 'side') {
                if (counts.g === 0) { wolfWin = true; winReason = "å± é‚Š (ç¥è·å…¨æ»…)"; }
                else if (counts.v === 0) { wolfWin = true; winReason = "å± é‚Š (å¹³æ°‘å…¨æ»…)"; }
            } 
            // 4. å± åŸ
            else {
                if (goodCount === 0) { wolfWin = true; winReason = "å± åŸ (å¥½äººå…¨æ»…)"; }
            }

            if (wolfWin) {
                if (pendingNightGun || pendingDayGun) {
                    log(`âš ï¸ é”æˆ${winReason}æ¢ä»¶ï¼Œä½†éœ€ç­‰å¾…çµäºº/ç‹¼ç‹é–‹æ§...`, 'log-info');
                    banner.style.display = "none";
                    return;
                }
                banner.innerText = "ğŸ† ç‹¼äººé™£ç‡Ÿ ç²å‹ï¼";
                banner.style.display = "block";
                log(`ğŸ† éŠæˆ²çµæŸï¼šç‹¼äººé™£ç‡Ÿç²å‹ (${winReason})`, 'log-win');
            } else {
                banner.style.display = "none";
            }
        }

        function resolveNight() {
            pendingNightGun = false; 

            const inputs = {
                wolf: document.getElementById("n-wolf").value,
                seer: document.getElementById("n-seer").value,
                poison: document.getElementById("n-poison").value,
                save: document.getElementById("n-save").value,
                guard: document.getElementById("n-guard").value,
                beauty: document.getElementById("n-beauty").value
            };

            log(`\n=== ç¬¬ ${nightCount} å¤œçµç®— ===`, 'log-header');
            
            if(inputs.wolf && inputs.wolf !== '0') log(`ğŸº ç‹¼åˆ€ -> ${inputs.wolf}è™Ÿ`, 'log-kill');
            else log(`ğŸº ç‹¼äººç©ºåˆ€`, 'log-action');
            if(inputs.guard) log(`ğŸ›¡ï¸ å®ˆ -> ${inputs.guard}è™Ÿ`, 'log-guard');

            let seerObj = roles.find(r => r.name === 'é è¨€å®¶' && r.alive);
            if(inputs.seer) {
                const target = findRole(inputs.seer);
                if(target) {
                    let res = (target.type === 'wolf' && !target.isHidden) ? "ç‹¼äºº" : "å¥½äºº";
                    log(`ğŸ”® é©— ${inputs.seer}è™Ÿ -> ${res}`, 'log-info');
                }
            }
            if(inputs.save) log(`ğŸ’Š æ•‘ -> ${inputs.save}è™Ÿ`, 'log-save');
            if(inputs.poison) log(`â˜ ï¸ æ¯’ -> ${inputs.poison}è™Ÿ`, 'log-poison');
            if(inputs.beauty) {
                log(`ğŸ’‹ é€£ -> ${inputs.beauty}è™Ÿ`, 'log-action');
                beautyLink = inputs.beauty;
            }

            let deadReasons = {}; 

            // A. é è¨€å®¶é©—æƒ¡éˆ
            if (inputs.seer && seerObj) {
                const target = findRole(inputs.seer);
                if (target && target.isGhoul && !target.reboundUsed) {
                    log(`âš ï¸ [é‚è¼¯] é è¨€å®¶é©—æƒ¡éˆ -> åå‚·è§¸ç™¼`, 'log-kill');
                    deadReasons[seerObj.number] = 'ghoul_rebound';
                    target.reboundUsed = true; 
                }
            }

            // B. å¥³å·«æ¯’
            if (inputs.poison) {
                const t = findRole(inputs.poison);
                const witch = roles.find(r => r.name === 'å¥³å·«' && r.alive);
                
                if (t && t.isGhoul) {
                    if (!t.reboundUsed && witch) {
                        log(`âš ï¸ [é‚è¼¯] å¥³å·«æ¯’æƒ¡éˆ(åå‚·åœ¨) -> åå‚·è§¸ç™¼`, 'log-kill');
                        deadReasons[witch.number] = 'ghoul_rebound';
                        t.reboundUsed = true;
                        log(`ğŸ›¡ï¸ æƒ¡éˆå…ç–«æ¯’`, 'log-immune');
                    } else {
                        log(`ğŸ›¡ï¸ æƒ¡éˆå…ç–«æ¯’ (åå‚·å·²æ¶ˆè€—)`, 'log-immune');
                    }
                } else if (t && t.isRogue) {
                     log(`ğŸ›¡ï¸ è€æµæ°“å…ç–«æ¯’`, 'log-immune');
                } else if (t) {
                    deadReasons[inputs.poison] = 'poison';
                }
            }

            // C. ç‹¼åˆ€
            if (inputs.wolf && inputs.wolf !== '0') {
                const t = findRole(inputs.wolf);
                const isSaved = (inputs.wolf === inputs.save);
                const isGuarded = (inputs.wolf === inputs.guard);
                
                if (t) {
                    if (isSaved && isGuarded) {
                        deadReasons[inputs.wolf] = 'milk_kill'; 
                    } else if (!isSaved && !isGuarded) {
                        if (t.isGhoul) log(`ğŸ˜ˆ æƒ¡éˆå…ç–«ç‹¼åˆ€`, 'log-immune');
                        else deadReasons[inputs.wolf] = 'wolf';
                    }
                }
            }

            let finalDead = Object.keys(deadReasons);
            const beauty = roles.find(r => r.isBeauty && r.alive);
            if (beauty && finalDead.includes(beauty.number) && beautyLink) {
                 deadReasons[beautyLink] = 'beauty_link';
                 finalDead.push(beautyLink);
            }

            finalDead = [...new Set(finalDead)];

            if (finalDead.length === 0) {
                log(`ğŸŒ• å¤©äº®ï¼šå¹³å®‰å¤œ`, 'log-info');
            } else {
                log(`ğŸ’€ å¤©äº®ï¼š${finalDead.join(', ')}è™Ÿ å€’ç‰Œ`, 'log-kill');
                finalDead.forEach(num => {
                    const r = findRole(num);
                    if (r) {
                        r.alive = false;
                        const reason = deadReasons[num];
                        if (r.isHunter && (reason === 'wolf' || reason === 'milk_kill' || reason === 'ghoul_rebound')) {
                            pendingNightGun = true; // å¤œæ§é–å®š
                        }
                        checkHunterSkill(r, reason); 
                    }
                });
            }

            checkBearGrowl(finalDead); 

            document.querySelectorAll('.night-grid input').forEach(i => i.value = '');
            nightCount++;
            render(); updateStats(); checkWin();
        }

        function checkBearGrowl(finalDeadNumbers) {
            const bear = roles.find(r => r.isBear && r.alive);
            if (!bear) return; 

            const alivePlayers = roles.filter(r => r.alive).sort((a,b) => a.number - b.number);
            if (alivePlayers.length < 2) return; 

            const bearIndex = alivePlayers.findIndex(r => r.number === bear.number);
            const leftIndex = (bearIndex - 1 + alivePlayers.length) % alivePlayers.length;
            const rightIndex = (bearIndex + 1) % alivePlayers.length;
            
            const leftPlayer = alivePlayers[leftIndex];
            const rightPlayer = alivePlayers[rightIndex];

            const isLeftWolf = (leftPlayer.type === 'wolf' && !leftPlayer.isHidden);
            const isRightWolf = (rightPlayer.type === 'wolf' && !rightPlayer.isHidden);

            if (isLeftWolf || isRightWolf) {
                log(`ğŸ» é¦´ç†Šå¸« -> å’†å“®ï¼`, 'log-bear-yes');
            } else {
                log(`ğŸ» é¦´ç†Šå¸« -> æ²’å’†å“®`, 'log-bear-no');
            }
        }

        function dayAction() {
            const action = document.getElementById("day-action").value;
            const targetNum = document.getElementById("day-target").value;
            
            if (action === 'æ”¾é€' && targetNum == 0) {
                log(`\nâš–ï¸ ç™½å¤©: æŠ•ç¥¨å¹³ç¥¨ -> ç„¡äººè¢«æ”¾é€`, 'log-tie');
                document.getElementById("day-target").value = "";
                return; 
            }

            if (!targetNum) return alert("è«‹è¼¸å…¥è™Ÿç¢¼ (å¹³ç¥¨è«‹è¼¸0)");
            const target = findRole(targetNum);
            if (!target) return alert("æ‰¾ä¸åˆ°æ­¤è™Ÿç¢¼");

            if (action === 'ç™½ç‹¼ç‹è‡ªçˆ†') {
                const wwk = roles.find(r => r.isWWK && r.alive);
                if (!wwk) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å­˜æ´»çš„ç™½ç‹¼ç‹");
                if (confirm(`ğŸ’¥ ç¢ºèªç™½ç‹¼ç‹(${wwk.number}è™Ÿ) è‡ªçˆ†ä¸¦å¸¶èµ° ${targetNum}è™Ÿå—ï¼Ÿ`)) {
                    log(`\nâ˜€ï¸ ç™½å¤©: ç™½ç‹¼ç‹(${wwk.number}è™Ÿ) è‡ªçˆ† -> å¸¶èµ° ${targetNum}è™Ÿ`, 'log-kill');
                    wwk.alive = false;
                    target.alive = false;
                    checkHunterSkill(target, 'wwk_boom'); 
                }
            } 
            else if (action === 'çµäººå¤œæ§') {
                log(`\nâ˜€ï¸ ç™½å¤©: ${action} -> ${targetNum}è™Ÿ`, 'log-action');
                if (confirm(`${targetNum}è™Ÿ è¢«çµäººå¤œæ§å¸¶èµ°ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                    if (target.isGhoul) {
                        log(`ğŸ›¡ï¸ çµäººå¤œæ§å°„æ“Šæƒ¡éˆé¨å£« -> æƒ¡éˆå…ç–« (å¤œé–“å‚·å®³ç„¡æ•ˆ)`, 'log-immune');
                        alert("æƒ¡éˆé¨å£«å…ç–«å¤œé–“å‚·å®³ï¼");
                        pendingNightGun = false;
                        checkWin(); // é›–æ²’æ­»ï¼Œä½†å¤œæ§å·²æ¶ˆè€—ï¼Œé‡æª¢æ¸¬å‹åˆ©
                        return; 
                    }
                    target.alive = false;
                    pendingNightGun = false; 
                    checkHunterSkill(target, 'gun');
                    if (target.isBeauty && beautyLink) triggerBeautyDeath();
                }
            }
            else if (action === 'çµäººæ—¥æ§' || action === 'ç‹¼ç‹é–‹æ§') {
                log(`\nâ˜€ï¸ ç™½å¤©: ${action} -> ${targetNum}è™Ÿ`, 'log-action');
                if (confirm(`${targetNum}è™Ÿ è¢«å¸¶èµ°ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                    if (target.isGhoul) log(`ğŸ”« ${action} -> æƒ¡éˆé¨å£« (ç™½å¤©è™•æ±º -> æ­»äº¡)`, 'log-kill');
                    target.alive = false;
                    pendingDayGun = false; // æ—¥æ§å·²æ¶ˆè€— (v5.7æ–°å¢)
                    checkHunterSkill(target, 'gun');
                    if (target.isBeauty && beautyLink) triggerBeautyDeath();
                }
            }
            else {
                log(`\nâ˜€ï¸ ç™½å¤©: ${action} -> ${targetNum}è™Ÿ`, 'log-action');

                if (action === 'æ±ºé¬¥') {
                    const knight = roles.find(r => r.name === 'é¨å£«' && r.alive);
                    if (target.type === 'wolf') {
                        log(`âš”ï¸ æ±ºé¬¥æˆåŠŸï¼ç‹¼äºº ${targetNum}è™Ÿ æ­»äº¡`, 'log-kill');
                        target.alive = false;
                        checkHunterSkill(target, 'duel'); 
                    } else {
                        log(`âš”ï¸ æ±ºé¬¥å¤±æ•—ï¼é¨å£« ${knight.number}è™Ÿ æ­»äº¡`, 'log-kill');
                        knight.alive = false;
                    }
                } 
                else if (action === 'æ”¾é€') {
                    if (target.isIdiot) {
                        log(`ğŸƒ ${targetNum}è™Ÿç™½ç™¡è¢«æ”¾é€ -> ç¿»ç‰Œ (å…ç–«æ·˜æ±°)`, 'log-idiot');
                        alert(`ğŸ¤¡ ${targetNum}è™Ÿæ˜¯ç™½ç™¡ï¼\nè«‹ç¿»ç‰Œäº®èº«åˆ†ï¼Œä½†ä»–ä¸æœƒå‡ºå±€ã€‚`);
                        document.getElementById("day-target").value = "";
                        return; 
                    }
                    if (confirm(`${targetNum}è™Ÿ æ”¾é€ï¼Œç¢ºå®šå‡ºå±€å—ï¼Ÿ`)) {
                        target.alive = false;
                        // --- v5.7 ä¿®æ­£ï¼šçµäºº/ç‹¼ç‹è¢«æ”¾é€ï¼Œå•Ÿå‹•æ—¥æ§é–å®š ---
                        if (target.isHunter) pendingDayGun = true; 
                        checkHunterSkill(target, 'vote');
                        if (target.isBeauty && beautyLink) triggerBeautyDeath();
                    }
                }
                else if (confirm(`${targetNum}è™Ÿ ${action}ï¼Œç¢ºå®šå‡ºå±€å—ï¼Ÿ`)) {
                    target.alive = false;
                    let reason = 'death';
                    if (action === 'ç‹¼äººè‡ªçˆ†') reason = 'suicide';
                    else if (action.includes('é–‹æ§')) reason = 'gun';
                    
                    checkHunterSkill(target, reason);
                    if (target.isBeauty && beautyLink) triggerBeautyDeath();
                }
            }

            document.getElementById("day-target").value = "";
            render(); updateStats(); checkWin();
        }

        function triggerBeautyDeath() {
             const linked = findRole(beautyLink);
             if (linked && linked.alive) {
                 log(`ğŸ’‹ ç‹¼ç¾äººæ®‰æƒ…å¸¶èµ° ${beautyLink}è™Ÿ`, 'log-kill');
                 linked.alive = false;
                 checkHunterSkill(linked, 'beauty_link');
             }
        }

        function checkHunterSkill(role, reason) {
            if (!role.isHunter) return; 
            const name = role.name;
            
            if (reason === 'poison') log(`ğŸš« ${name}è¢«æ¯’æ®º -> ç„¡æ³•é–‹æ§`, 'log-hunter-no');
            else if (reason === 'beauty_link') log(`ğŸš« ${name}è¢«æ®‰æƒ… -> ç„¡æ³•é–‹æ§`, 'log-hunter-no');
            else if (reason === 'suicide') { if(name === 'ç‹¼ç‹') log(`ğŸš« ç‹¼ç‹è‡ªçˆ† -> ç„¡æ³•é–‹æ§`, 'log-hunter-no'); }
            
            else {
                let gunType = "æ—¥æ§"; 
                if (['wolf', 'milk_kill', 'ghoul_rebound'].includes(reason)) {
                    gunType = "å¤œæ§";
                    log(`ğŸ”« ${name}å‡ºå±€ (${getReasonText(reason)}) -> è«‹è©¢å•æ˜¯å¦é–‹æ§ <span style="color:#f1c40f">[æ­¤ç‚º${gunType}]</span>`, 'log-hunter-yes');
                } else {
                    gunType = "æ—¥æ§";
                    log(`ğŸ”« ${name}å‡ºå±€ (${getReasonText(reason)}) -> è«‹è©¢å•æ˜¯å¦é–‹æ§ <span style="color:#2ecc71">[æ­¤ç‚º${gunType}]</span>`, 'log-hunter-yes');
                }
            }
        }

        function getReasonText(code) {
            const map = { 'wolf': 'ç‹¼åˆ€', 'milk_kill': 'å¥¶ç©¿', 'vote': 'æ”¾é€', 'duel': 'æ±ºé¬¥', 'ghoul_rebound': 'åå‚·', 'beauty_link': 'æ®‰æƒ…', 'gun': 'é–‹æ§', 'wwk_boom': 'ç™½çˆ†' };
            return map[code] || 'æ­»äº¡';
        }

        function findRole(num) { return roles.find(r => r.number == num); }
        function log(msg, cls) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div class="${cls}">${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function resetKeepConfig() {
            if(!confirm("ç¢ºå®šè¦ä¿ç•™è§’è‰²é…ç½®ï¼Œä½†æ¸…ç©ºè™Ÿç¢¼èˆ‡ç´€éŒ„å—ï¼Ÿ\n(å°‡é–‹å§‹æ–°çš„ä¸€å±€)")) return;
            roles.forEach(r => {
                r.alive = true;
                r.number = '';
                if(r.isGhoul) r.reboundUsed = false;
            });
            nightCount = 1;
            beautyLink = null;
            pendingNightGun = false;
            pendingDayGun = false;
            document.getElementById("log-area").innerHTML = '<span style="color:#7f8c8d;">ç­‰å¾…éŠæˆ²é–‹å§‹...</span>';
            document.querySelectorAll('input').forEach(i => {
                if(i.type === 'number' || i.type === 'text') i.value = '';
            });
            document.getElementById("win-banner").style.display = "none";
            render();
            updateStats();
        }
    </script>
</body>
</html>