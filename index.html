<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ®ºæ³•å®˜åŠ©æ‰‹ v5.0 (å°ˆå®¶é‚è¼¯)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a1a1a; color: #ddd; padding: 10px; max-width: 700px; margin: 0 auto; }
        h2 { text-align: center; color: #e74c3c; margin: 10px 0; letter-spacing: 2px; }
        
        .mode-switch { text-align: center; margin-bottom: 15px; background: #333; padding: 10px; border-radius: 8px; }
        .radio-label { margin: 0 10px; cursor: pointer; font-weight: bold; }
        input[type="radio"] { transform: scale(1.2); margin-right: 5px; }

        .dashboard { display: flex; justify-content: space-between; background: #2c3e50; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
        .count-box { text-align: center; width: 30%; }
        .count-number { font-size: 2em; font-weight: bold; }
        .c-wolf { color: #e74c3c; } 
        .c-god { color: #f1c40f; } 
        .c-villager { color: #2ecc71; } 
        
        .win-banner { display: none; background: #c0392b; color: white; text-align: center; padding: 10px; font-size: 1.5em; font-weight: bold; border-radius: 8px; margin-bottom: 10px; animation: pop 0.5s; border: 2px solid #e74c3c; }

        .section { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #7f8c8d; }
        .sec-wolf { border-left-color: #c0392b; }
        .sec-day { border-left-color: #e67e22; }
        .section-header { font-weight: bold; margin-bottom: 10px; color: #ecf0f1; display: flex; justify-content: space-between; }

        select, input { padding: 8px; margin: 5px 0; background: #2c3e50; color: white; border: 1px solid #7f8c8d; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { border: none; padding: 10px; border-radius: 4px; cursor: pointer; color: white; width: 100%; margin-top: 5px; font-size: 14px; font-weight: bold; }
        .btn-add { background: #2980b9; width: auto; }
        .btn-calc { background: #c0392b; font-size: 1.1em; }
        .btn-day { background: #d35400; }
        
        .role-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: #2c3e50; margin-bottom: 5px; border-radius: 3px; border-left: 4px solid #555; }
        .type-wolf { border-left-color: #e74c3c; }
        .type-god { border-left-color: #f1c40f; }
        .type-villager { border-left-color: #2ecc71; }
        .dead { opacity: 0.5; text-decoration: line-through; background: #222; }
        .role-num { width: 60px; text-align: center; background: #ecf0f1; color: #2c3e50; font-weight: bold; margin: 0 10px; font-size: 1.1em; padding: 5px; border:none; }
        
        .badge { font-size: 0.7em; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }
        .b-ghoul { background: #8e44ad; }
        .b-beauty { background: #fd79a8; color: #2d3436; }
        .b-bear { background: #d35400; }
        .b-idiot { background: #95a5a6; color: #2c3e50; }

        .night-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .night-group label { font-size: 0.9em; color: #bdc3c7; }

        #log-area { background: #000; padding: 15px; height: 250px; overflow-y: auto; font-family: monospace; border: 1px solid #444; line-height: 1.6; white-space: pre-wrap; font-size: 14px; color: #eee; }
        
        .log-header { color: #3498db; font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #333; padding-bottom:3px; display:block; }
        .log-action { color: #bdc3c7; } 
        .log-kill { color: #e74c3c; font-weight: bold; } 
        .log-poison { color: #9b59b6; font-weight: bold; } 
        .log-save { color: #2ecc71; } 
        .log-guard { color: #f1c40f; } 
        .log-info { color: #3498db; }
        .log-idiot { color: #f1c40f; font-weight: bold; border: 1px solid #f1c40f; padding: 2px 5px; border-radius: 3px; }
        .log-bear-yes { color: #e74c3c; font-weight: bold; background: #2c3e50; padding: 3px 6px; border-radius: 4px; border: 1px solid #c0392b; display: inline-block; margin-top: 5px;}
        .log-bear-no { color: #2ecc71; font-weight: bold; background: #2c3e50; padding: 3px 6px; border-radius: 4px; border: 1px solid #27ae60; display: inline-block; margin-top: 5px;}
        .log-hunter-yes { color: #2ecc71; font-weight: bold; background: #2c3e50; padding: 2px 5px; border-radius: 3px;}
        .log-hunter-no { color: #e74c3c; font-weight: bold; background: #2c3e50; padding: 2px 5px; border-radius: 3px; text-decoration: line-through;}
        .log-win { color: #f1c40f; font-weight: bold; font-size: 1.1em; border: 2px solid #f1c40f; padding: 5px; text-align: center; margin-top: 5px; }

        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®ºæ³•å®˜ v5.0</h2>

    <div class="mode-switch">
        <span style="color: #aaa; margin-right: 10px;">å‹åˆ©æ¢ä»¶:</span>
        <label class="radio-label"><input type="radio" name="winMode" value="side" checked onchange="checkWin()">å± é‚Šå±€</label>
        <label class="radio-label"><input type="radio" name="winMode" value="city" onchange="checkWin()">å± åŸå±€</label>
    </div>

    <div id="win-banner" class="win-banner"></div>

    <div class="dashboard">
        <div class="count-box"><div class="c-wolf">ç‹¼äºº</div><div id="cnt-wolf" class="count-number">0</div></div>
        <div class="count-box"><div class="c-god">ç¥è·</div><div id="cnt-god" class="count-number">0</div></div>
        <div class="count-box"><div class="c-villager">å¹³æ°‘</div><div id="cnt-villager" class="count-number">0</div></div>
    </div>

    <div class="section">
        <div class="section-header">1. è§’è‰²é…ç½® (è‡ªå‹•æ’åº)</div>
        <div style="display: flex; gap: 5px;">
            <select id="roleSelect">
                <optgroup label="ğŸº ç‹¼äººé™£ç‡Ÿ">
                    <option value="ç‹¼äºº|wolf">ç‹¼äºº</option>
                    <option value="ç‹¼ç‹|wolf">ç‹¼ç‹</option>
                    <option value="ç™½ç‹¼ç‹|wolf">ç™½ç‹¼ç‹</option>
                    <option value="æƒ¡éˆé¨å£«|wolf">æƒ¡éˆé¨å£«</option>
                    <option value="éš±ç‹¼|wolf">éš±ç‹¼</option>
                    <option value="ç‹¼ç¾äºº|wolf">ç‹¼ç¾äºº</option>
                </optgroup>
                <optgroup label="ğŸ”® ç¥è·é™£ç‡Ÿ">
                    <option value="é è¨€å®¶|god">é è¨€å®¶</option>
                    <option value="å¥³å·«|god">å¥³å·«</option>
                    <option value="çµäºº|god">çµäºº</option>
                    <option value="å®ˆè¡›|god">å®ˆè¡›</option>
                    <option value="é¨å£«|god">é¨å£«</option>
                    <option value="é¦´ç†Šå¸«|god">é¦´ç†Šå¸«</option>
                    <option value="ç™½ç™¡|god">ç™½ç™¡</option>
                </optgroup>
                <optgroup label="ğŸ‘± å¹³æ°‘é™£ç‡Ÿ">
                    <option value="å¹³æ°‘|villager">å¹³æ°‘</option>
                    <option value="è€æµæ°“|villager">è€æµæ°“</option>
                </optgroup>
            </select>
            <button class="btn-add" onclick="addRole()">æ–°å¢</button>
        </div>
        <div id="role-list" style="margin-top: 10px;"></div>
    </div>

    <div class="section sec-wolf">
        <div class="section-header">ğŸŒ™ å¤œæ™šè¡Œå‹• (æŒ‰é †åºçµç®—)</div>
        <div class="night-grid">
            <div class="night-group">
                <label>ğŸº ç‹¼åˆ€:</label>
                <input type="number" id="n-wolf" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ”® é è¨€å®¶é©—:</label>
                <input type="number" id="n-seer" placeholder="#">
            </div>
            <div class="night-group">
                <label>â˜ ï¸ å¥³å·«æ¯’:</label>
                <input type="number" id="n-poison" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ’Š å¥³å·«æ•‘:</label>
                <input type="number" id="n-save" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ›¡ï¸ å®ˆè¡›å®ˆ:</label>
                <input type="number" id="n-guard" placeholder="#">
            </div>
            <div class="night-group">
                <label>ğŸ’‹ ç‹¼ç¾é€£:</label>
                <input type="number" id="n-beauty" placeholder="#">
            </div>
        </div>
        <button class="btn-calc" onclick="resolveNight()">ğŸŒ• å¤©äº®çµç®— (å•Ÿå‹•é‚è¼¯å¼•æ“)</button>
    </div>

    <div class="section sec-day">
        <div class="section-header">â˜€ï¸ ç™½å¤©æ“ä½œ</div>
        <div style="display: flex; gap: 5px;">
            <select id="day-action" style="flex: 1;">
                <option value="æ”¾é€">ğŸ—³ï¸ æŠ•ç¥¨æ”¾é€</option>
                <option value="çµäººé–‹æ§">ğŸ”« çµäººé–‹æ§</option>
                <option value="ç‹¼ç‹é–‹æ§">ğŸº ç‹¼ç‹é–‹æ§</option>
                <option value="æ±ºé¬¥">âš”ï¸ é¨å£«æ±ºé¬¥</option>
                <option value="ç‹¼äººè‡ªçˆ†">ğŸ’¥ ç‹¼äººè‡ªçˆ†</option>
            </select>
            <input type="number" id="day-target" placeholder="#" style="width: 60px;">
            <button class="btn-day" style="width: auto;" onclick="dayAction()">åŸ·è¡Œ</button>
        </div>
    </div>

    <div id="log-area"><span style="color:#7f8c8d;">ç­‰å¾…éŠæˆ²é–‹å§‹...</span></div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="resetKeepConfig()" style="background: #2980b9; flex: 2;">ä¿ç•™é…ç½®é‡æ–°éŠæˆ²</button>
        <button onclick="if(confirm('ç¢ºå®šè¦å®Œå…¨æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ')) location.reload();" style="background: #555; flex: 1;">å®Œå…¨é‡ç½®</button>
    </div>

    <script>
        let roles = [];
        let beautyLink = null;
        let nightCount = 1;

        function addRole() {
            const val = document.getElementById("roleSelect").value.split('|');
            const name = val[0];
            const type = val[1];
            roles.push({
                name: name, type: type, number: '', alive: true,
                isGhoul: name === 'æƒ¡éˆé¨å£«', reboundUsed: false,
                isHidden: name === 'éš±ç‹¼', isRogue: name === 'è€æµæ°“',
                isBeauty: name === 'ç‹¼ç¾äºº', isHunter: (name === 'çµäºº' || name === 'ç‹¼ç‹'),
                isBear: name === 'é¦´ç†Šå¸«', isIdiot: name === 'ç™½ç™¡', isWWK: name === 'ç™½ç‹¼ç‹'
            });
            sortRoles(); render(); updateStats();
        }

        function sortRoles() {
            const order = { 'wolf': 1, 'god': 2, 'villager': 3 };
            roles.sort((a, b) => order[a.type] - order[b.type]);
        }

        function render() {
            const list = document.getElementById("role-list");
            list.innerHTML = "";
            let hasAliveWWK = false;

            roles.forEach((r, idx) => {
                const div = document.createElement("div");
                div.className = `role-item type-${r.type} ${r.alive ? '' : 'dead'}`;
                let tags = "";
                if (r.isGhoul) tags += `<span class="badge b-ghoul">æƒ¡éˆ</span>`;
                if (r.isBeauty) tags += `<span class="badge b-beauty">ç‹¼ç¾</span>`;
                if (r.isBear) tags += `<span class="badge b-bear">ç†Š</span>`;
                if (r.isIdiot) tags += `<span class="badge b-idiot">ç™½ç™¡</span>`;

                if (r.isWWK && r.alive) hasAliveWWK = true;

                div.innerHTML = `
                    <div style="flex:1">
                        <span style="font-weight:bold">${r.name}</span>
                        ${tags}
                    </div>
                    <input type="number" class="role-num" placeholder="#" value="${r.number}" 
                        onchange="roles[${idx}].number=this.value" ${!r.alive?'disabled':''}>
                    <button style="width:auto; padding:5px 10px; background:${r.alive?'#2ecc71':'#e74c3c'}" 
                        onclick="toggleLife(${idx})">${r.alive?'å­˜':'äº¡'}</button>
                    <button style="width:auto; background:none; padding:0 5px;" onclick="delRole(${idx})">âœ•</button>
                `;
                list.appendChild(div);
            });
            updateDayOptions(hasAliveWWK);
        }

        function updateDayOptions(hasAliveWWK) {
            const select = document.getElementById("day-action");
            const wwkOptionValue = "ç™½ç‹¼ç‹è‡ªçˆ†";
            let exists = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === wwkOptionValue) exists = true;
            }
            if (hasAliveWWK && !exists) {
                const opt = document.createElement("option");
                opt.value = wwkOptionValue;
                opt.text = "ğŸ’¥ ç™½ç‹¼ç‹è‡ªçˆ†å¸¶äºº";
                opt.style.color = "#e74c3c";
                opt.style.fontWeight = "bold";
                select.add(opt);
            } else if (!hasAliveWWK && exists) {
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === wwkOptionValue) select.remove(i);
                }
            }
        }

        function toggleLife(idx) {
            roles[idx].alive = !roles[idx].alive;
            render(); updateStats(); checkWin();
        }
        function delRole(idx) { roles.splice(idx, 1); render(); updateStats(); }

        function updateStats() {
            let w=0, g=0, v=0;
            roles.forEach(r => {
                if (r.alive) {
                    if (r.type === 'wolf') w++;
                    if (r.type === 'god') g++;
                    if (r.type === 'villager') v++;
                }
            });
            document.getElementById("cnt-wolf").innerText = w;
            document.getElementById("cnt-god").innerText = g;
            document.getElementById("cnt-villager").innerText = v;
            return { w, g, v };
        }

        // --- ä¿®æ­£2: 1v1 å‹åˆ©åˆ¤å®š ---
        function checkWin() {
            const counts = updateStats();
            const mode = document.querySelector('input[name="winMode"]:checked').value;
            const banner = document.getElementById("win-banner");
            
            // 1. ç‹¼äººå…¨æ»… -> å¥½äººè´
            if (counts.w === 0 && roles.length > 0) {
                banner.innerText = "ğŸ† å¥½äººé™£ç‡Ÿ ç²å‹ï¼";
                banner.style.display = "block";
                log("ğŸ† éŠæˆ²çµæŸï¼šå¥½äººé™£ç‡Ÿç²å‹", 'log-win');
                return;
            }

            let wolfWin = false;
            
            // 2. æ®˜å±€åˆ¤å®š (1ç‹¼ vs 1å¥½äºº -> ç‹¼è´)
            const totalGood = counts.g + counts.v;
            if (counts.w >= 1 && totalGood === 1) {
                wolfWin = true;
                log("âš”ï¸ æ®˜å±€åˆ¤å®šï¼šå ´ä¸Šåƒ…å‰© 1å¥½äºº vs ç‹¼äººï¼Œç‹¼åˆ€å„ªå…ˆ -> ç‹¼äººç²å‹", 'log-info');
            }
            // 3. å¸¸è¦åˆ¤å®š (å± é‚Š/å± åŸ)
            else if (mode === 'side') {
                if ((counts.g === 0 || counts.v === 0) && counts.w > 0) wolfWin = true;
            } else {
                if (counts.g === 0 && counts.v === 0 && counts.w > 0) wolfWin = true;
            }

            if (wolfWin) {
                banner.innerText = "ğŸ† ç‹¼äººé™£ç‡Ÿ ç²å‹ï¼";
                banner.style.display = "block";
                log("ğŸ† éŠæˆ²çµæŸï¼šç‹¼äººé™£ç‡Ÿç²å‹", 'log-win');
            } else {
                banner.style.display = "none";
            }
        }

        // --- ä¿®æ­£1 & 3: å°ˆå®¶ç´šé‚è¼¯å¼•æ“ ---
        function resolveNight() {
            const inputs = {
                wolf: document.getElementById("n-wolf").value,
                seer: document.getElementById("n-seer").value,
                poison: document.getElementById("n-poison").value,
                save: document.getElementById("n-save").value,
                guard: document.getElementById("n-guard").value,
                beauty: document.getElementById("n-beauty").value
            };

            log(`\n=== ç¬¬ ${nightCount} å¤œçµç®— (é‚è¼¯å¼•æ“å•Ÿå‹•) ===`, 'log-header');
            
            // 1. å‹•ä½œæ’­å ±
            if(inputs.wolf && inputs.wolf !== '0') log(`ğŸº ç‹¼äººåˆ€ -> ${inputs.wolf}è™Ÿ`, 'log-kill');
            else log(`ğŸº ç‹¼äººç©ºåˆ€`, 'log-action');
            if(inputs.guard) log(`ğŸ›¡ï¸ å®ˆè¡›å®ˆ -> ${inputs.guard}è™Ÿ`, 'log-guard');

            // é è¨€å®¶æ’­å ± (å…ˆä¸è™•ç†åå‚·ï¼Œåªæ’­å ±)
            let seerObj = roles.find(r => r.name === 'é è¨€å®¶' && r.alive);
            if(inputs.seer) {
                const target = findRole(inputs.seer);
                if(target) {
                    let res = (target.type === 'wolf' && !target.isHidden) ? "ç‹¼äºº" : "å¥½äºº";
                    log(`ğŸ”® é è¨€å®¶é©— ${inputs.seer}è™Ÿ -> ${res}`, 'log-info');
                }
            }
            if(inputs.save) log(`ğŸ’Š å¥³å·«æ•‘ -> ${inputs.save}è™Ÿ`, 'log-save');
            if(inputs.poison) log(`â˜ ï¸ å¥³å·«æ¯’ -> ${inputs.poison}è™Ÿ`, 'log-poison');
            if(inputs.beauty) {
                log(`ğŸ’‹ ç‹¼ç¾äººé€£ -> ${inputs.beauty}è™Ÿ`, 'log-action');
                beautyLink = inputs.beauty;
            }

            // 2. é‹ç®—é‚è¼¯ (åš´æ ¼é †åº)
            let deadReasons = {}; 

            // A. é è¨€å®¶çµç®— (å„ªå…ˆç´šæœ€é«˜ï¼šè§¸ç™¼åå‚·)
            // é‚è¼¯ï¼šå¦‚æœé è¨€å®¶æ´»è‘—ï¼Œä¸”æŸ¥é©—äº†æƒ¡éˆï¼Œä¸”æƒ¡éˆåå‚·é‚„åœ¨ -> é è¨€å®¶æ­»ï¼Œåå‚·æ¶ˆè€—
            if (inputs.seer && seerObj) {
                const target = findRole(inputs.seer);
                if (target && target.isGhoul && !target.reboundUsed) {
                    log(`âš ï¸ [é‚è¼¯] é è¨€å®¶å…ˆæ‰‹æŸ¥é©—æƒ¡éˆ -> è§¸ç™¼åå‚·`, 'log-kill');
                    deadReasons[seerObj.number] = 'ghoul_rebound';
                    target.reboundUsed = true; // æ¨™è¨˜åå‚·å·²æ¶ˆè€—
                }
            }

            // B. å¥³å·«æ¯’è—¥çµç®— (æ¬¡å„ªå…ˆç´š)
            // é‚è¼¯ï¼šå¦‚æœç›®æ¨™æ˜¯æƒ¡éˆ
            //   - è‹¥åå‚·é‚„åœ¨(ä»£è¡¨æ²’è¢«é è¨€å®¶é©—) -> å¥³å·«æ­»ï¼Œåå‚·æ¶ˆè€—ï¼Œæ¯’ç„¡æ•ˆ
            //   - è‹¥åå‚·å·²æ¶ˆè€—(ä»£è¡¨å·²è¢«é è¨€å®¶é©—) -> å¥³å·«ä¸æ­»ï¼Œæ¯’ç„¡æ•ˆ(å¤œæ™šç„¡æ•µ)
            if (inputs.poison) {
                const t = findRole(inputs.poison);
                const witch = roles.find(r => r.name === 'å¥³å·«' && r.alive);
                
                if (t && t.isGhoul) {
                    if (!t.reboundUsed && witch) {
                        // æƒ…æ³ï¼šé è¨€å®¶æ²’é©—æƒ¡éˆï¼Œå¥³å·«æ¯’æƒ¡éˆ -> è§¸ç™¼åå‚·
                        log(`âš ï¸ [é‚è¼¯] å¥³å·«æŠ•æ¯’æƒ¡éˆ (åå‚·å°šå­˜) -> è§¸ç™¼åå‚·`, 'log-kill');
                        deadReasons[witch.number] = 'ghoul_rebound';
                        t.reboundUsed = true;
                        log(`ğŸ›¡ï¸ æƒ¡éˆé¨å£«å…ç–«æ¯’æ®º`, 'log-info');
                    } else {
                        // æƒ…æ³ï¼šé è¨€å®¶å·²ç¶“è§¸ç™¼åå‚·ï¼Œæˆ–è€…åå‚·ä¹‹å‰ç”¨éäº† -> æƒ¡éˆå–®ç´”å…ç–«
                        log(`ğŸ›¡ï¸ æƒ¡éˆé¨å£«å…ç–«æ¯’æ®º (åå‚·å·²æ¶ˆè€—æˆ–ä¸è§¸ç™¼)`, 'log-info');
                    }
                } else if (t && t.isRogue) {
                     log(`ğŸ›¡ï¸ è€æµæ°“å…ç–«æ¯’æ®º`, 'log-info');
                } else if (t) {
                    deadReasons[inputs.poison] = 'poison';
                }
            }

            // C. ç‹¼åˆ€çµç®— (æœ€å¾Œåˆ¤å®š)
            if (inputs.wolf && inputs.wolf !== '0') {
                const t = findRole(inputs.wolf);
                const isSaved = (inputs.wolf === inputs.save);
                const isGuarded = (inputs.wolf === inputs.guard);
                
                if (t) {
                    if (isSaved && isGuarded) {
                        deadReasons[inputs.wolf] = 'milk_kill'; 
                    } else if (!isSaved && !isGuarded) {
                        if (t.isGhoul) log(`ğŸ˜ˆ æƒ¡éˆé¨å£«å…ç–«ç‹¼åˆ€`, 'log-info');
                        else deadReasons[inputs.wolf] = 'wolf';
                    }
                }
            }

            // 3. åŸ·è¡Œæ­»äº¡
            let finalDead = Object.keys(deadReasons);
            const beauty = roles.find(r => r.isBeauty && r.alive);
            // ç‹¼ç¾å¦‚æœåœ¨æœ¬è¼ªæ­»äº¡åå–®ä¸­
            if (beauty && finalDead.includes(beauty.number) && beautyLink) {
                 deadReasons[beautyLink] = 'beauty_link';
                 finalDead.push(beautyLink);
            }

            finalDead = [...new Set(finalDead)];

            if (finalDead.length === 0) {
                log(`ğŸŒ• å¤©äº®äº†ï¼šå¹³å®‰å¤œ`, 'log-info');
            } else {
                log(`ğŸ’€ å¤©äº®äº†ï¼š${finalDead.join(', ')}è™Ÿ å€’ç‰Œ`, 'log-kill');
                finalDead.forEach(num => {
                    const r = findRole(num);
                    if (r) {
                        r.alive = false;
                        checkHunterSkill(r, deadReasons[num]); 
                    }
                });
            }

            checkBearGrowl(finalDead); 

            document.querySelectorAll('.night-grid input').forEach(i => i.value = '');
            nightCount++;
            render(); updateStats(); checkWin();
        }

        function checkBearGrowl(finalDeadNumbers) {
            const bear = roles.find(r => r.isBear && r.alive);
            if (!bear) return; 

            const alivePlayers = roles.filter(r => r.alive).sort((a,b) => a.number - b.number);
            if (alivePlayers.length < 2) return; 

            const bearIndex = alivePlayers.findIndex(r => r.number === bear.number);
            const leftIndex = (bearIndex - 1 + alivePlayers.length) % alivePlayers.length;
            const rightIndex = (bearIndex + 1) % alivePlayers.length;
            
            const leftPlayer = alivePlayers[leftIndex];
            const rightPlayer = alivePlayers[rightIndex];

            const isLeftWolf = (leftPlayer.type === 'wolf' && !leftPlayer.isHidden);
            const isRightWolf = (rightPlayer.type === 'wolf' && !rightPlayer.isHidden);

            if (isLeftWolf || isRightWolf) {
                log(`ğŸ» é¦´ç†Šå¸«æ„Ÿæ‡‰ -> å’†å“®ï¼ (å‘¨åœæœ‰ç‹¼)`, 'log-bear-yes');
            } else {
                log(`ğŸ» é¦´ç†Šå¸«æ„Ÿæ‡‰ -> æ²’æœ‰å’†å“®`, 'log-bear-no');
            }
        }

        function dayAction() {
            const action = document.getElementById("day-action").value;
            const targetNum = document.getElementById("day-target").value;
            if (!targetNum) return alert("è«‹è¼¸å…¥è™Ÿç¢¼");
            const target = findRole(targetNum);
            if (!target) return alert("æ‰¾ä¸åˆ°æ­¤è™Ÿç¢¼");

            if (action === 'ç™½ç‹¼ç‹è‡ªçˆ†') {
                const wwk = roles.find(r => r.isWWK && r.alive);
                if (!wwk) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å­˜æ´»çš„ç™½ç‹¼ç‹");
                
                if (confirm(`ğŸ’¥ ç¢ºèªç™½ç‹¼ç‹(${wwk.number}è™Ÿ) è‡ªçˆ†ä¸¦å¸¶èµ° ${targetNum}è™Ÿå—ï¼Ÿ`)) {
                    log(`\nâ˜€ï¸ ç™½å¤©: ç™½ç‹¼ç‹(${wwk.number}è™Ÿ) è‡ªçˆ† -> å¸¶èµ° ${targetNum}è™Ÿ`, 'log-kill');
                    wwk.alive = false;
                    target.alive = false;
                    checkHunterSkill(target, 'wwk_boom'); 
                }
            } 
            else {
                log(`\nâ˜€ï¸ ç™½å¤©: ${action} -> ${targetNum}è™Ÿ`, 'log-action');

                if (action === 'æ±ºé¬¥') {
                    const knight = roles.find(r => r.name === 'é¨å£«' && r.alive);
                    if (target.type === 'wolf') {
                        log(`âš”ï¸ æ±ºé¬¥æˆåŠŸï¼ç‹¼äºº ${targetNum}è™Ÿ æ­»äº¡`, 'log-kill');
                        target.alive = false;
                        checkHunterSkill(target, 'duel'); 
                    } else {
                        log(`âš”ï¸ æ±ºé¬¥å¤±æ•—ï¼é¨å£« ${knight.number}è™Ÿ æ­»äº¡`, 'log-kill');
                        knight.alive = false;
                    }
                } 
                else if (action === 'æ”¾é€') {
                    if (target.isIdiot) {
                        log(`ğŸƒ ${targetNum}è™Ÿç™½ç™¡è¢«æ”¾é€ -> ç¿»ç‰Œ (å…ç–«æ·˜æ±°)`, 'log-idiot');
                        alert(`ğŸ¤¡ ${targetNum}è™Ÿæ˜¯ç™½ç™¡ï¼\nè«‹ç¿»ç‰Œäº®èº«åˆ†ï¼Œä½†ä»–ä¸æœƒå‡ºå±€ï¼Œè«‹ç¹¼çºŒéŠæˆ²ã€‚`);
                        document.getElementById("day-target").value = "";
                        return; 
                    }
                    if (confirm(`${targetNum}è™Ÿ æ”¾é€ï¼Œç¢ºå®šå‡ºå±€å—ï¼Ÿ`)) {
                        target.alive = false;
                        checkHunterSkill(target, 'vote');
                        if (target.isBeauty && beautyLink) triggerBeautyDeath();
                    }
                }
                else if (confirm(`${targetNum}è™Ÿ ${action}ï¼Œç¢ºå®šå‡ºå±€å—ï¼Ÿ`)) {
                    target.alive = false;
                    let reason = 'death';
                    if (action === 'ç‹¼äººè‡ªçˆ†') reason = 'suicide';
                    else if (action.includes('é–‹æ§')) reason = 'gun';
                    
                    checkHunterSkill(target, reason);
                    if (target.isBeauty && beautyLink) triggerBeautyDeath();
                }
            }

            document.getElementById("day-target").value = "";
            render(); updateStats(); checkWin();
        }

        function triggerBeautyDeath() {
             const linked = findRole(beautyLink);
             if (linked && linked.alive) {
                 log(`ğŸ’‹ ç‹¼ç¾äººæ®‰æƒ…å¸¶èµ° ${beautyLink}è™Ÿ`, 'log-kill');
                 linked.alive = false;
                 checkHunterSkill(linked, 'beauty_link');
             }
        }

        function checkHunterSkill(role, reason) {
            if (!role.isHunter) return; 
            const name = role.name;
            if (reason === 'poison') log(`ğŸš« ${name}è¢«æ¯’æ®º -> ç„¡æ³•é–‹æ§`, 'log-hunter-no');
            else if (reason === 'beauty_link') log(`ğŸš« ${name}è¢«æ®‰æƒ… -> ç„¡æ³•é–‹æ§`, 'log-hunter-no');
            else if (reason === 'suicide') { if(name === 'ç‹¼ç‹') log(`ğŸš« ç‹¼ç‹è‡ªçˆ† -> ç„¡æ³•é–‹æ§`, 'log-hunter-no'); }
            
            else log(`ğŸ”« ${name}å‡ºå±€ (${getReasonText(reason)}) -> è«‹è©¢å•æ˜¯å¦é–‹æ§`, 'log-hunter-yes');
        }

        function getReasonText(code) {
            const map = { 'wolf': 'ç‹¼åˆ€', 'milk_kill': 'å¥¶ç©¿', 'vote': 'æ”¾é€', 'duel': 'æ±ºé¬¥', 'ghoul_rebound': 'åå‚·', 'beauty_link': 'æ®‰æƒ…', 'gun': 'é–‹æ§', 'wwk_boom': 'ç™½çˆ†' };
            return map[code] || 'æ­»äº¡';
        }

        function findRole(num) { return roles.find(r => r.number == num); }
        function log(msg, cls) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div class="${cls}">${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function resetKeepConfig() {
            if(!confirm("ç¢ºå®šè¦ä¿ç•™è§’è‰²é…ç½®ï¼Œä½†æ¸…ç©ºè™Ÿç¢¼èˆ‡ç´€éŒ„å—ï¼Ÿ\n(å°‡é–‹å§‹æ–°çš„ä¸€å±€)")) return;
            roles.forEach(r => {
                r.alive = true;
                r.number = '';
                if(r.isGhoul) r.reboundUsed = false;
            });
            nightCount = 1;
            beautyLink = null;
            document.getElementById("log-area").innerHTML = '<span style="color:#7f8c8d;">ç­‰å¾…éŠæˆ²é–‹å§‹...</span>';
            document.querySelectorAll('input').forEach(i => {
                if(i.type === 'number' || i.type === 'text') i.value = '';
            });
            document.getElementById("win-banner").style.display = "none";
            render();
            updateStats();
        }
    </script>
</body>
</html>